if("undefined"==typeof OGX){var OGX={};OGX.StarEngine=function(){}}OGX.StarEngine.prototype.PixiTileEngine=function(e){function i(e,i){e&&(R=i,Y.tile={x:Math.floor(R.x/Number(v.tileSize)),y:Math.floor(R.y/Number(v.tileSize))},Y.x=R.x,Y.y=R.y,R.viz={},R.viz.x=Math.ceil(Y.width/(N.tileSize/2)/2)+1,R.viz.y=Math.ceil(Y.height/(N.tileSize/4)/2)+1,console.log("width iso",(2*R.viz.x+1)*N.tileSize/2),console.log("height iso",(2*R.viz.y+1)*N.tileSize/4),console.log("iso viz x",R.viz.x),console.log("iso viz y",R.viz.y))}function t(e){var i=Y.tile.x,t=1,l=Y.tile.x,n=Math.ceil(Y.width/e/(N.tileSize/2)/2)+1,o=Y.tile.x-n,s=Y.tile.y-n,r=Y.tile.x+n,d=Y.tile.y+n,a=R.viz.x,_=Math.ceil(n-a);if(console.log("render zoom ",Y.zoom,"diff",_,"newViz",n),_){for(var z=0;z<Math.abs(_);z++)for(var g=s;g<d+1;g++)for(var S=o;S<r+1;S++)w=!1,I=!1,B.x=S*N.tileSize,B.y=g*N.tileSize,L=h(B),v.levels[1].tiles["t_"+S+"_"+g]?(I=!0,w=v.levels[1].tiles["t_"+S+"_"+g].border):w=!0,I&&(U["t_"+S+"_"+g]={pt2d:B,ptIso:L}),w&&y(S,g),i-=t,l+=t,i===Y.tile.x-n&&(t*=-1);Y.offset=N.tileSize*(n+1)*2*e-N.tileSize*(R.viz.x+1)*2*Y.zoom,R.viz.x=n,R.viz.y=n,Y.zoom=e,f.position.x=(B.x+N.width/2)*e,f.position.y=(B.y+N.height/2)*e,x(m)}}function l(){Y.x=R.x,Y.y=R.y,Y.tile.x=Math.floor(R.x/N.tileSize),Y.tile.y=Math.floor(R.y/N.tileSize),R.tile={x:Y.tile.x,y:Y.tile.y};for(var e=Y.tile.x,i=1,t=Y.tile.x,l=Y.tile.x-R.viz.x,n=Y.tile.y-R.viz.y,o=Y.tile.x+R.viz.x,s=Y.tile.y+R.viz.y,r=n;r<s+1;r++){for(var d=l;d<o+1;d++)w=!1,I=!1,B.x=d*N.tileSize,B.y=r*N.tileSize,L=h(B),d<e||d>t||(v.levels[1].tiles["t_"+d+"_"+r]?(I=!0,w=v.levels[1].tiles["t_"+d+"_"+r].border):w=!0,I&&(U["t_"+d+"_"+r]={pt2d:B,ptIso:L}),w&&y(d,r));e-=i,t+=i,e===Y.tile.x-R.viz.x&&(i*=-1)}return R.tile=Y.tile,B.x=-R.x,B.y=-R.y,B=h(B),f.position.x=B.x+N.width*Y.zoom/2,f.position.y=B.y+N.height*Y.zoom/2,x(m),!0}function n(){if(D={x:Math.floor(R.x/N.tileSize),y:Math.floor(R.y/N.tileSize)},M=D.y!==Y.tile.y,P=D.x!==Y.tile.x,O=Math.ceil(Y.tile.x-D.x)*-1,b=Math.ceil(Y.tile.y-D.y)*-1,P&&M)for(var e={x:Y.tile.x,y:Y.tile.y+b*R.viz.y*-1},i={x:D.x,y:D.y+R.viz.y*b},t=2*R.viz.x+1,l=i.x,n=i.y,o=e.x,s=e.y,r=0,d=0;d<t;d++)w=!1,I=!1,B.x=l*N.tileSize,B.y=n*N.tileSize,q={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},v.levels[1].tiles["t_"+l+"_"+n]?(I=!0,w=v.levels[1].tiles["t_"+l+"_"+n].border):w=!0,I&&(U["t_"+l+"_"+n]={pt2d:B,ptIso:h(B)}),w&&y(l,n),k["t_"+o+"_"+s]&&(V["t_"+o+"_"+s]=!0),Z["t_"+o+"_"+s]&&(Z["t_"+o+"_"+s].destroy(),delete Z["t_"+o+"_"+s]),0===r?(n+=b*-1,s+=b,r=1):(l+=O,o+=O*-1,r=0);else if(P)for(var a=R.tile.y-R.viz.y,_=D.y+R.viz.y,z=R.tile.x+O,g=z+R.viz.x*O,S=R.tile.x,u=a;u<_+1;u++)w=!1,I=!1,B.x=z*N.tileSize,B.y=u*N.tileSize,q={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},v.levels[1].tiles["t_"+z+"_"+u]?(I=!0,w=v.levels[1].tiles["t_"+z+"_"+u].border):(w=!0,I=!1),I&&(U["t_"+z+"_"+u]={pt2d:B,ptIso:h(B)}),w&&y(z,u),Z["t_"+S+"_"+u]&&(Z["t_"+S+"_"+u].destroy(),delete Z["t_"+S+"_"+u]),k["t_"+S+"_"+u]&&(V["t_"+S+"_"+u]=!0),z+O===g+O&&(O*=-1),z+=O,S-=O;else if(M)for(var c=R.tile.x-R.viz.x,p=D.x+R.viz.x,T=R.tile.y+b,E=T+R.viz.y*b,C=R.tile.y,X=c;X<p+1;X++)w=!1,I=!1,B.x=X*N.tileSize,B.y=T*N.tileSize,q={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},v.levels[1].tiles["t_"+X+"_"+T]?(I=!0,w=v.levels[1].tiles["t_"+X+"_"+T].border):w=!0,I&&(U["t_"+X+"_"+T]={pt2d:B,ptIso:h(B)}),w&&y(X,T),Z["t_"+X+"_"+C]&&(Z["t_"+X+"_"+C].destroy(),delete Z["t_"+X+"_"+C]),k["t_"+X+"_"+C]&&(V["t_"+X+"_"+C]=!0),T+b===E+b&&(b*=-1),T+=b,C-=b;return(P||M)&&x(m),R.tile=D,Y.tile=D,Y.x=R.x,Y.y=R.y,R.tile=Y.tile,B.x=-R.x,B.y=-R.y,B=h(B),f.position.x=B.x+N.width/Y.zoom/2,f.position.y=B.y+N.height/Y.zoom/2,!0}function o(){c.position.y=-83;for(var e in U)v.levels[1].tiles[e]&&(X=new OGX.StarEngine.Tile(N.tileSize),X.setTexture(v.levels[1].tiles[e].texture),X.tile=U[e].pt2d,X.x=X.img.x=U[e].ptIso.x,X.y=X.img.y=U[e].ptIso.y-X.img.height,X.img.z=X.img.y+X.img.height,X.name=e,c.addChild(X.img),k[e]=X);return U={},x(c),!0}function s(){var e;for(e in U)v.levels[1].tiles[e]&&(k[e]||(E=v.levels[1].tiles[e],C=new OGX.StarEngine.Tile(N.tileSize),C.setTexture(v.levels[1].tiles[e].texture),C.tile=U[e].pt2d,C.x=C.img.x=U[e].ptIso.x,C.y=C.img.y=U[e].ptIso.y-C.img.height,C.img.z=C.img.y+C.img.height,C.name=e,c.addChild(C.img),k[e]=C));for(e in V)k[e].destroy(),delete k[e];return U={},V={},e&&x(c),!0}function r(){var e;for(e in Z)Z[e].destroy(),delete Z[e];Z={};for(e in k)k[e].destroy(),delete k[e];k={}}function h(e){var i={x:0,y:0},t=e.x/2,l=e.x/4*-1,n=e.y/2,o=e.y/4*-1;return i.x=t+n,i.y=l-o,i}function y(e,i){if(v.levels[0].tiles["t_"+e+"_"+i]){switch(E=v.levels[0].tiles["t_"+e+"_"+i],C=new OGX.StarEngine.Tile(N.tileSize),C.setTexture(E.texture),C.tile.x=e,C.tile.y=i,C.x=C.img.x=E.posIso.x,C.y=C.img.y=E.posIso.y-C.img.height,C.img.z=C.img.y+C.img.height,E.type){case OGX.StarEngine.BaseTile.TILE_TYPE_STATIC_Z:case OGX.StarEngine.BaseTile.TILE_TYPE_DYNAMIC_Z:m.addChild(C.img);break;case OGX.StarEngine.BaseTile.TILE_TYPE_STATIC:case OGX.StarEngine.BaseTile.TILE_TYPE_DYNAMIC:u.addChild(C.img)}Z["t_"+e+"_"+i]=C}}function x(e){e.children.sort(d)}function d(e,i){return e.z<i.z?-1:e.z>i.z?1:0}function a(e){e?(this.state=this.STATE_RUN,requestAnimationFrame(_)):this.state=this.STATE_STOP}function _(){this.state===this.STATE_RUN&&(G.begin(),n(),s(),p.render(S),requestAnimationFrame(_),G.end())}function z(){S=new PIXI.Stage(15658734,!0),p=new PIXI.WebGLRenderer(N.width,N.height,null),p.view.style.width=N.width+"px",p.view.style.height=N.height+"px",p.view.style.display="block",document.getElementById(N.container).appendChild(p.view),T=new PIXI.RenderTexture(N.width,N.height),A.resize=new PIXI.Container,f=new PIXI.Container,A.resize.addChild(f),u=new PIXI.Container,f.addChild(u),m=new PIXI.Container,f.addChild(m),c=new PIXI.Container,f.addChild(c),S.addChild(A.resize),G=new Stats,document.body.appendChild(G.domElement),G.domElement.style.position="absolute",G.domElement.style.top="0px"}function g(){z(),Y.w=N.width,Y.h=N.height}var v,f,S,u,m,c,p,T,w,I,E,C,X,P,M,O,b,G,A=this,N=e,R=N.camera,Y={x:null,y:null,offset:0,width:e.width,height:e.height,zoom:1,tile:{}},B={x:0,y:0},L={x:0,y:0},U={},V={},Z={},k={},q={x:0,y:0,width:0,height:0},D={x:0,y:0};this.STATE_RUN="stateRun",this.STATE_STOP="stateStop",this.state=this.STATE_STOP,this.resize=null,this.setCamera=function(e){i(!0,e)},this.setMap=function(e){v=e},this.setZoom=function(e){t(e),A.resize.scale={x:e,y:e}},this.renderView=function(){l(),n(),o(),s(),p.render(S)},this.clearView=function(){r()},this.start=function(){R&&v&&a(!0)},this.stop=function(){a(!1)},g()},OGX.StarEngine.PixiTileEngine=function(e){"use strict";return new OGX.StarEngine.prototype.PixiTileEngine(e)};