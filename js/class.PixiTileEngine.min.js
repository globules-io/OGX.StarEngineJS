if("undefined"==typeof OGX){var OGX={};OGX.StarEngine=function(){}}OGX.StarEngine.prototype.PixiTileEngine=function(e){function t(e,t){e&&(D=t,Y.tile={x:Math.floor(D.x/Number(S.tileSize)),y:Math.floor(D.y/Number(S.tileSize))},Y.x=D.x,Y.y=D.y,D.viz={},D.viz.x=Math.ceil(Y.width/(N.tileSize/2)/2)+1,D.viz.y=Math.ceil(Y.height/(N.tileSize/4)/2)+1)}function i(e){var t=Y.tile.x,i=1,l=Y.tile.x,n=Math.ceil(Y.width/e/(N.tileSize/2)/2)+1,o=Y.tile.x-n,r=Y.tile.y-n,s=Y.tile.x+n,a=Y.tile.y+n,d=D.viz.x,_=Math.ceil(n-d);if(console.log("render zoom ",Y.zoom,"diff",_,"newViz",n),_){for(var z=0;z<Math.abs(_);z++)for(var g=r;g<a+1;g++)for(var f=o;f<s+1;f++)w=!1,X=!1,B.x=f*N.tileSize,B.y=g*N.tileSize,U=x(B),S.levels[1].tiles["t_"+f+"_"+g]?(X=!0,w=S.levels[1].tiles["t_"+f+"_"+g].border):w=!0,X&&(V["t_"+f+"_"+g]={pt2d:B,ptIso:U}),w&&h(f,g),t-=i,l+=i,t===Y.tile.x-n&&(i*=-1);Y.offset=N.tileSize*(n+1)*2*e-N.tileSize*(D.viz.x+1)*2*Y.zoom,D.viz.x=n,D.viz.y=n,Y.zoom=e,v.position.x=(B.x+N.width/2)*e,v.position.y=(B.y+N.height/2)*e,y(T)}}function l(){Y.x=D.x,Y.y=D.y,Y.tile.x=Math.floor(D.x/N.tileSize),Y.tile.y=Math.floor(D.y/N.tileSize),D.tile={x:Y.tile.x,y:Y.tile.y};for(var e=Y.tile.x,t=1,i=Y.tile.x,l=Y.tile.x-D.viz.x,n=Y.tile.y-D.viz.y,o=Y.tile.x+D.viz.x,r=Y.tile.y+D.viz.y,s=n;s<r+1;s++){for(var a=l;a<o+1;a++)w=!1,X=!1,B.x=a*N.tileSize,B.y=s*N.tileSize,U=x(B),a<e||a>i||(S.levels[1].tiles["t_"+a+"_"+s]?(X=!0,w=S.levels[1].tiles["t_"+a+"_"+s].border):w=!0,X&&(V["t_"+a+"_"+s]={pt2d:B,ptIso:U}),w&&h(a,s));e-=t,i+=t,e===Y.tile.x-D.viz.x&&(t*=-1)}return D.tile=Y.tile,B.x=-D.x,B.y=-D.y,B=x(B),v.position.x=B.x+N.width*Y.zoom/2,v.position.y=B.y+N.height*Y.zoom/2,y(T),!0}function n(){if(j={x:Math.floor(D.x/N.tileSize),y:Math.floor(D.y/N.tileSize)},M=j.y!==Y.tile.y,G=j.x!==Y.tile.x,b=Math.ceil(Y.tile.x-j.x)*-1,A=Math.ceil(Y.tile.y-j.y)*-1,G&&M)for(var e={x:Y.tile.x,y:Y.tile.y+A*D.viz.y*-1},t={x:j.x,y:j.y+D.viz.y*A},i=2*D.viz.x+1,l=t.x,n=t.y,o=e.x,r=e.y,s=0,a=0;a<i;a++)w=!1,X=!1,B.x=l*N.tileSize,B.y=n*N.tileSize,F={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},S.levels[1].tiles["t_"+l+"_"+n]?(X=!0,w=S.levels[1].tiles["t_"+l+"_"+n].border):w=!0,X&&(V["t_"+l+"_"+n]={pt2d:B,ptIso:x(B)}),w&&h(l,n),q["t_"+o+"_"+r]&&(Z["t_"+o+"_"+r]=!0),k["t_"+o+"_"+r]&&(k["t_"+o+"_"+r].destroy(),delete k["t_"+o+"_"+r]),0===s?(n+=A*-1,r+=A,s=1):(l+=b,o+=b*-1,s=0);else if(G)for(var d=D.tile.y-D.viz.y,_=j.y+D.viz.y,z=D.tile.x+b,g=z+D.viz.x*b,f=D.tile.x,u=d;u<_+1;u++)w=!1,X=!1,B.x=z*N.tileSize,B.y=u*N.tileSize,F={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},S.levels[1].tiles["t_"+z+"_"+u]?(X=!0,w=S.levels[1].tiles["t_"+z+"_"+u].border):(w=!0,X=!1),X&&(V["t_"+z+"_"+u]={pt2d:B,ptIso:x(B)}),w&&h(z,u),k["t_"+f+"_"+u]&&(k["t_"+f+"_"+u].destroy(),delete k["t_"+f+"_"+u]),q["t_"+f+"_"+u]&&(Z["t_"+f+"_"+u]=!0),z+b===g+b&&(b*=-1),z+=b,f-=b;else if(M)for(var m=D.tile.x-D.viz.x,c=j.x+D.viz.x,p=D.tile.y+A,I=p+D.viz.y*A,E=D.tile.y,C=m;C<c+1;C++)w=!1,X=!1,B.x=C*N.tileSize,B.y=p*N.tileSize,F={x:B.x,y:B.y,width:N.tileSize,height:N.tileSize},S.levels[1].tiles["t_"+C+"_"+p]?(X=!0,w=S.levels[1].tiles["t_"+C+"_"+p].border):w=!0,X&&(V["t_"+C+"_"+p]={pt2d:B,ptIso:x(B)}),w&&h(C,p),k["t_"+C+"_"+E]&&(k["t_"+C+"_"+E].destroy(),delete k["t_"+C+"_"+E]),q["t_"+C+"_"+E]&&(Z["t_"+C+"_"+E]=!0),p+A===I+A&&(A*=-1),p+=A,E-=A;return(G||M)&&y(T),D.tile=j,Y.tile=j,Y.x=D.x,Y.y=D.y,D.tile=Y.tile,B.x=-D.x,B.y=-D.y,B=x(B),v.position.x=B.x+N.width/Y.zoom/2,v.position.y=B.y+N.height/Y.zoom/2,!0}function o(){p.position.y=-83;for(var e in V)S.levels[1].tiles[e]&&(O=new OGX.StarEngine.Tile(N.tileSize),O.setTexture(S.levels[1].tiles[e].texture),O.tile=V[e].pt2d,O.x=O.img.x=V[e].ptIso.x,O.y=O.img.y=V[e].ptIso.y-O.img.height,O.img.z=O.img.y+O.img.height,O.name=e,p.addChild(O.img),q[e]=O);return V={},y(p),!0}function r(){var e;for(e in V)S.levels[1].tiles[e]&&(q[e]||(C=S.levels[1].tiles[e],P=new OGX.StarEngine.Tile(N.tileSize),P.setTexture(S.levels[1].tiles[e].texture),P.tile=V[e].pt2d,P.x=P.img.x=V[e].ptIso.x,P.y=P.img.y=V[e].ptIso.y-P.img.height,P.img.z=P.img.y+P.img.height,P.name=e,p.addChild(P.img),q[e]=P));for(e in Z)q[e].destroy(),delete q[e];return V={},Z={},e&&y(p),!0}function s(){var e;for(e in k)k[e].destroy(),delete k[e];k={};for(e in q)q[e].destroy(),delete q[e];q={}}function x(e){var t={x:0,y:0},i=e.x/2,l=e.x/4*-1,n=e.y/2,o=e.y/4*-1;return t.x=i+n,t.y=l-o,t}function h(e,t){if(S.levels[0].tiles["t_"+e+"_"+t]){switch(C=S.levels[0].tiles["t_"+e+"_"+t],P=new OGX.StarEngine.Tile(N.tileSize),P.setTexture(C.texture),P.tile.x=e,P.tile.y=t,P.x=P.img.x=C.posIso.x,P.y=P.img.y=C.posIso.y-P.img.height,P.img.z=P.img.y+P.img.height,C.type){case OGX.StarEngine.BaseTile.TILE_TYPE_STATIC_Z:case OGX.StarEngine.BaseTile.TILE_TYPE_DYNAMIC_Z:T.addChild(P.img);break;case OGX.StarEngine.BaseTile.TILE_TYPE_STATIC:case OGX.StarEngine.BaseTile.TILE_TYPE_DYNAMIC:c.addChild(P.img)}k["t_"+e+"_"+t]=P}}function y(e){e.children.sort(a)}function a(e,t){return e.z<t.z?-1:e.z>t.z?1:0}function d(e){e?(this.state=this.STATE_RUN,requestAnimationFrame(_)):this.state=this.STATE_STOP}function _(){this.state===this.STATE_RUN&&(L.begin(),n(),r(),I.render(m),requestAnimationFrame(_),L.end())}function z(){for(var e=0;e<N.textures.length;e++)PIXI.loader.add(N.textures[e]+".json"),PIXI.loader.add(N.textures[e]+".png");PIXI.loader.load(g)}function g(){$(document).trigger(OGX.StarEngine.TEXTURES_LOADED)}function f(){m=new PIXI.Container,I=new PIXI.WebGLRenderer(N.width,N.height,null),I.view.style.width=N.width+"px",I.view.style.height=N.height+"px",I.view.style.display="block",document.getElementById(N.container).appendChild(I.view),E=new PIXI.RenderTexture.create(N.width,N.height),R.resize=new PIXI.Container,v=new PIXI.Container,R.resize.addChild(v),c=new PIXI.Container,v.addChild(c),T=new PIXI.Container,v.addChild(T),p=new PIXI.Container,v.addChild(p),m.addChild(R.resize),L=new Stats,document.body.appendChild(L.domElement),L.domElement.style.position="absolute",L.domElement.style.top="0px"}function u(){f(),Y.w=N.width,Y.h=N.height,z()}var S,v,m,c,T,p,I,E,w,X,C,P,O,G,M,b,A,L,R=this,N=e,D=N.camera,Y={x:null,y:null,offset:0,width:e.width,height:e.height,zoom:1,tile:{}},B={x:0,y:0},U={x:0,y:0},V={},Z={},k={},q={},F={x:0,y:0,width:0,height:0},j={x:0,y:0};this.STATE_RUN="stateRun",this.STATE_STOP="stateStop",this.state=this.STATE_STOP,this.resize=null,this.setCamera=function(e){t(!0,e)},this.setMap=function(e){S=e},this.setZoom=function(e){i(e),R.resize.scale={x:e,y:e}},this.renderView=function(){l(),n(),o(),r(),I.render(m)},this.clearView=function(){s()},this.start=function(){D&&S&&d(!0)},this.stop=function(){d(!1)},u()},OGX.StarEngine.PixiTileEngine=function(e){"use strict";return new OGX.StarEngine.prototype.PixiTileEngine(e)},OGX.StarEngine.TEXTURES_LOADED="StarEngineTexturesLoaded";